= Pdfs from Antora using pagedjs

This project adapts the principles behind asciidoctor-pdf.js to work in Antora.

* Slight tweaks to html generation.
* UI project adapted to pdf output based on pagedjs.
* pdf rendering through headless Chromium controlled through Puppeteer.
* content supplied to Chromium by running a local server.

Current output:

* One pdf per output html page, or explicit configuration in component descriptors.
* pdfs are added to the `_attachments` directory in the component, in the same directory structure as the pages.

== How to set this up

The (relative) paths shown in this guide all reflect the relative project layouts on my system.

----
~/projects/antora/antora
~/projects/asciidoctor/asciidoctor-pdf.js
----

You will need to adjust paths to suit the project locations you choose.

=== Antora

You need a local copy of Antora with several MRs applied.

* link:https://gitlab.com/antora/antora/merge_requests/423[Upgrade to Asciidoctor.js 2.0.x]
* link:https://gitlab.com/antora/antora/merge_requests/440[Allow a custom converter to replace/override the default HTML5 converter]
* A fix for link:https://gitlab.com/antora/antora/issues/552[cli should allow specifying UI start_path as well as the UI bundle itself]

The plausible way to get this is by cloning my link:https://gitlab.com/djencks/antora[Antora fork] and checking out the `issue-522-347-548-asciidoctor-2-delegating-converters-explicit-converters` branch.
Note the name of this branch no longer reflects it's contents.

=== This project, asciidoctor-pdf.js, antora branch

After you've cloned (from my fork) and switched to this branch, modify this projects root package.json to link the projects.
The monorepo configuration is at the end of package.json:

----
"workspaces": [
    "packages/*",
    "../../antora/antora/packages/*"
  ]
----

Modify the second line to contain the relative path between projects in your installation.
Finally run yarn in this project to set up the monorepo here.

== Set up a way to run your local copy of antora

in e.g. `~/.profile`, `export ANTORA_DEV=~/projects/antora/antora/node_modules/.bin/antora`

== UI

Get the `pdf-with-hbs` `antora-ui-default` branch from link:https://gitlab.com/djencks/antora-ui-default[my fork] and build it.
You'll need the path to it for your playbook or command line.

== (Optional) Set up your playbook if you want a simpler command line

----
ui:
  bundle:
    url: ./../../../antora-ui-default/build/ui-pdf-bundle.zip
    snapshot: true
    start_path: pdf
----

== Running

A typical command line in this directory, specifying both UI bundle and start_path:
----
 $ANTORA_DEV ../../antora/simple-examples/multiple-components/xrefs/antora-playbook.yml  --stacktrace --generator ./node_modules/\@antora-pdf/pdf-generator  --ui-bundle-url ../../antora/antora-ui-default/build/ui-pdf-bundle.zip --ui-start-path pdf
----

The pipeline module must be referred to with a local file path.

== Configuration

By default, all published pages are converted to pdf and put in each components `_attachments` directory.

Alternatively, you can list the files to convert in each component descriptor under the pdfFiles key, in the form `<module>:<relative>`.

----
pdfFiles:
- ROOT:_sitepdf.adoc
----

If this file is hidden (by the initial `\_`) it will be published anyway, with the initial `_` removed from the pdf name.

For instance, you can take a nav.adoc file and convert the `* \xref::` to `include::`.
Be sure to include e.g. `[lineoffset=1]`, where the lineoffset is most likely the number of `*` at the beginning of the line.

== Html "Preview"

The html that gets printed is written out in the normal spots in the site.
By commenting out a couple lines in converter.js you can see the same thing Chromium does at `http://localhost:8081`

== Next steps

cli tests? This is awkward until there is an easier ui bundle generator.

It's presumably possible to automatically convert nav.adoc files to "`including files`", but I'd like to see some real world experience with manual conversions before trying to implement this.

== Paged media/PDF configuration

To a large extent how this works is still a mystery to me...

An overview of how the paged media spec sets things up is here: link:https://www.pagedmedia.org/paged-js/[].

For Antora-pdf that is done in the UI bundle, in the `pdf/css/document.css` and `pdf/css/title-document-numbering.css` files.

There are some additional .css files referenced when the document calls for them.

== Known problems

* Often it's needed to insert an explicit page break `<<<` after the `:toc:` or content is left out.
Even so, there are sometimes problems with the pdf index.
* Images that are too large can make paged.js enter an infinite loop, repeating the section (?) the image is in over and over.
Explicitly setting the width sufficiently narrow fixes this, e.g. `image::my.png[width=90%]`.
If the configured width is too wide, the image may not appear or paged.js may loop.
I don't know how to predict an appropriate width percent: 90% has worked, some images work at 98%, others not at 97%.
`scaledwidth=80%` did not work for me.
* Background images on the title page don't work (? The SUSE manager pdfs have this, but I don't know how they do it).
* TOC page numbers are sometimes 0.
I suspect this has to do with pagination problems.
* Intradocument links now work (at least for uyuni docs).
* Outside-doc links generally get the site-url based url.
* Including an `a` type in a column specifier generally makes the table overflow the page width and breaks layout.
** With a table formerly using `a`, paragraphs (from blank lines) make paged.js go into an infinite loop, although not from overflow.
* Image:: refs must include the module and possibly component as they are likely to be pulled into a different module by inclusion.
